rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // role stocké dans /users/{uid}
    function myUserDoc() {
      return /databases/$(database)/documents/users/$(request.auth.uid);
    }
    function role() {
      return get(myUserDoc()).data.role;
    }
    function isAdmin() { return signedIn() && role() == "admin"; }
    function isMech()  { return signedIn() && role() == "mechanic"; }

    // IMPORTANT: ne pas utiliser isAdmin() dans la règle /users sinon boucle.
    match /users/{uid} {
      // chaque utilisateur peut lire SON doc (nécessaire pour role())
      allow read: if signedIn() && request.auth.uid == uid;

      // seul un admin peut écrire (changer roles, etc.)
      allow create, update, delete: if isAdmin();
    }

    match /customers/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    match /vehicles/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    match /workorders/{id} {
      allow read: if isAdmin()
        || (isMech() && resource.data.assignedTo == request.auth.uid);

      allow create: if isAdmin();

      allow update: if isAdmin()
        || (isMech()
            && resource.data.assignedTo == request.auth.uid
            && request.resource.data.assignedTo == resource.data.assignedTo);

      allow delete: if isAdmin();
    }

    match /appointments/{id} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // Promotions (page Promotions)
    match /promotions/{id} {
      allow read: if signedIn();
      // seule l'admin crée/modifie/supprime les promos
      allow create, update, delete: if isAdmin();
    }

    // Emails déclenchés par l’extension "Trigger Email from Firestore"
    // La page Promotions écrit des docs dans /mail.
    match /mail/{id} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    match /meta/{id} {
      allow read, write: if isAdmin();
    }
  }
}
